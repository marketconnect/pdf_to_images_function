### **Техническое задание на разработку Yandex Cloud Function "PdfToImagesFunction"**

**1. Общие сведения**

*   **Наименование функции:** `PdfToImagesFunction`
*   **Назначение:** Асинхронная конвертация (растрирование) файла формата PDF в набор изображений формата WebP. Функция является частью системы просмотра документов в режиме "read-only".
*   **Среда выполнения:** Yandex Cloud Functions
*   **Стек:** Python 3.9+, `pypdfium2`, `Pillow`, `boto3`.

**2. Требования к среде выполнения**

*   **Версия Python:** 3.9 или выше.
*   **Тайм-аут выполнения:** не менее 60 секунд (конвертация может быть длительной).
*   **Память:** не менее 512 МБ (обработка PDF и изображений требовательна к RAM).
*   **Сервисный аккаунт:** Функция должна быть привязана к сервисному аккаунту, имеющему права `storage.editor` на бакет, в котором хранятся файлы.

**3. Входные данные**

Функция должна принимать на вход JSON-объект со следующей структурой:

```json
{
  "pdf_key": "path/to/document.pdf",
  "output_prefix": "converted/path/to/document.xlsx/"
}
```

*   `pdf_key` (string, обязательный): Полный путь (ключ) к исходному PDF-файлу в Object Storage.
*   `output_prefix` (string, обязательный): Префикс (путь), по которому будут сохранены результирующие изображения и файл-маркер. **Важно:** префикс должен заканчиваться на `/`.

**4. Выходные данные**

**4.1. Успешное выполнение**

В случае успешной конвертации функция должна вернуть HTTP-статус `200 OK` и JSON-объект следующего вида:

```json
{
  "status": "success",
  "page_count": 5,
  "format": "webp"
}
```

*   `status` (string): Всегда `"success"`.
*   `page_count` (integer): Количество страниц в исходном PDF-файле (и количество созданных изображений).
*   `format` (string): Формат, в который были сконвертированы страницы (в нашем случае, всегда `"webp"`).

**4.2. Ошибка выполнения**

В случае любой ошибки (неверные входные данные, файл не найден, ошибка конвертации) функция должна вернуть соответствующий HTTP-статус ошибки (например, `400` или `500`) и JSON-объект с описанием проблемы:

```json
{
  "status": "error",
  "message": "Описание произошедшей ошибки"
}
```

**5. Алгоритм работы функции**

1.  **Инициализация:**
    *   Инициализировать клиент `boto3` для работы с Yandex Object Storage, используя переменные окружения.

2.  **Валидация входных данных:**
    *   Проверить наличие и корректность полей `pdf_key` и `output_prefix` во входном JSON. В случае ошибки вернуть ответ с HTTP-статусом `400`.

3.  **Скачивание PDF-файла:**
    *   Скачать PDF-файл, указанный в `pdf_key`, из Object Storage во временную директорию функции (`/tmp`). Имя локального файла может быть сгенерировано случайно.

4.  **Конвертация страниц:**
    *   Открыть скачанный PDF-файл с помощью библиотеки `pypdfium2`.
    *   Определить общее количество страниц в документе.
    *   Запустить цикл по всем страницам документа (от 0 до N-1).
    *   Внутри цикла для каждой страницы:
        a.  Рендерить страницу в растровый объект (bitmap) с помощью `pypdfium2`. Рекомендуемый DPI для рендеринга — 150, как баланс между качеством и размером.
        b.  Преобразовать полученный bitmap в объект изображения библиотеки `Pillow`.
        c.  Сохранить объект `Pillow` в байтовый поток (in-memory buffer) в формате **WebP** с уровнем качества ~80-85.
        d.  Сформировать ключ для загрузки изображения в Object Storage: `{output_prefix}page-{номер_страницы}.webp` (например, `converted/path/to/document.xlsx/page-1.webp`). Нумерация страниц должна начинаться с 1.
        e.  Загрузить сгенерированное изображение из байтового потока в Object Storage по сформированному ключу.

5.  **Создание файла-маркера (`manifest.json`):**
    *   После успешной обработки всех страниц создать в памяти JSON-объект: `{"page_count": N, "format": "webp"}`, где N — общее количество страниц.
    *   Сформировать ключ для манифеста: `{output_prefix}manifest.json`.
    *   Загрузить этот JSON-объект как файл в Object Storage по указанному ключу.

6.  **Очистка:**
    *   Удалить временный PDF-файл из директории `/tmp` для освобождения места.

7.  **Возврат результата:**
    *   Сформировать и вернуть успешный JSON-ответ, как описано в п. 4.1.

**6. Требования к зависимостям (`requirements.txt`)**

```
boto3
pypdfium2
Pillow
```

**7. Конфигурация и переменные окружения**

Функция должна конфигурироваться через следующие переменные окружения:

| Переменная | Описание | Пример значения |
| :--- | :--- | :--- |
| `S3_BUCKET_NAME` | Имя бакета в Object Storage | `my-documents-bucket` |
| `S3_ENDPOINT_URL` | URL эндпоинта Object Storage | `https://storage.yandexcloud.net` |
| `AWS_ACCESS_KEY_ID` | ID статического ключа сервисного аккаунта | `YC...` |
| `AWS_SECRET_ACCESS_KEY`| Секретный ключ сервисного аккаунта | `YC...` |
| `AWS_REGION` | Регион Object Storage | `ru-central1` |

**8. Обработка ошибок и логирование**

*   Функция должна логировать ключевые этапы своей работы (начало, скачивание файла, завершение конвертации).
*   В случае возникновения исключений (например, `S3.Client.NoSuchKey` при отсутствии файла, ошибка парсинга PDF в `pypdfium2`) необходимо перехватывать их, логировать подробную информацию об ошибке и возвращать JSON-ответ с ошибкой, как описано в п. 4.2.